# 需求与进度对账（2026-02-27）

## 1. 用户需求总表

1. 抽奖逻辑后端化：前端主要负责展示，抽奖逻辑与数据变更集中在后端项目体系。
2. 项目机制：先登录，再选择项目；后续请求携带 token 和项目标识，防止仅凭项目 ID 误操作。
3. 数据模型口径：手机号全平台唯一，对应一个自然人；不建立单独“团体”字段，以项目名单作为团体范围。
4. 项目间互动：支持项目 B 排除项目 A 的中奖用户；支持按指定奖项做排除。
5. 业务异常处理：当抽中不符合目标范围的人时，可作废并重抽，支持多轮。
6. 后台用户隔离：一个公司主体下，按部门（区域）隔离项目与数据访问。
7. 数据沉淀：中奖结果需保存，后台可导出。
8. 技术约束：后端优先 Django，数据库 PostgreSQL（127.0.0.1:5432，post-choujiang），迁移尽量用 `makemigrations`，不引入 Redis 等额外部署依赖。

## 2. 当前已完成

1. 后端 Django 主体与领域模型已建立：Department、AdminUser、Project、Customer、ProjectMember、Prize、DrawBatch、DrawWinner、ExclusionRule、ExportJob。
2. 数据库连接已验证可用，迁移已应用：
   - DB: `post-choujiang`
   - User: `post-choujiang`
   - Host/Port: `127.0.0.1:5432`
   - `accounts.0001_initial`、`lottery.0001_initial` 已应用。
3. 鉴权与项目隔离主链路已完成：
   - 登录 -> 选项目 -> 进入业务页面。
   - 请求自动注入 `Authorization: Bearer <token>` 与 `X-Project-Id`。
   - 后端已校验请求头项目与目标项目一致性。
4. 首页抽奖主流程已后端化：
   - 预抽（preview）/确认（confirm）/作废（void）已接入后端。
5. 后端导出能力已存在：
   - 支持创建导出任务并下载 CSV。
6. 后端进行中增强已写入代码（未提交）：
   - `draw-winners` 中奖记录列表与撤销。
   - `draw-winners/reset-project` 项目级重置中奖。
   - `project-members/clear-project` 清空项目名单并联动清理中奖状态。
7. 前端配置页后端化已完成：
   - 人员配置页改为后端成员接口（列表/单增/批量导入/单删/清空项目/重置中奖）。
   - 已中奖页改为后端中奖接口（汇总/明细/撤销），导出改为后端导出任务下载。
   - 奖项配置页改为后端奖项 CRUD（含拖拽排序持久化、分段人数保存）。

## 3. 当前未完成

1. 跨项目排除规则前端管理入口尚未闭环（后端已有 ExclusionRule 接口与服务逻辑）。
2. 导出流程目前已支持“创建后立即下载”，但缺少导出任务列表与状态追踪页面。
3. 角色细粒度控制（如 OPERATOR/VIEWER 的写权限限制）尚未收紧到最终策略。
4. 后端接口的自动化测试仍需补充为正式测试用例（当前主要是脚本冒烟验证）。

## 4. 风险与注意事项

1. 当前工作树有未提交后端改动，需要先收口验证再继续大面积前端迁移。
2. 涉及奖项名额变更（`used_count`）的接口必须始终按数据库事实回算，避免前端本地状态漂移。
3. 所有写操作都必须携带且校验 `X-Project-Id`，否则存在越权风险。
4. 迁移文件必须通过 `makemigrations` 生成，避免手写偏差。

## 5. 下一会话入口

请先阅读并按顺序执行：

1. `TODO_NEXT_SESSION.md`
2. `docs/DETAILED_EXECUTION_ROADMAP_2026-02-27.md`
